<script src="https://sdk.amazonaws.com/js/aws-sdk-2.947.0.min.js"></script>
<script>
    // AWS Configuration - Replace with your AWS settings
    AWS.config.update({
        region: 'ap-southeast-2', // Replace with your AWS region
        credentials: new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'ap-southeast-2:e1961e14-083d-4200-bb2b-c869a5ffbc3d'  // Replace with your Cognito Identity Pool ID
        })
    });

    const s3 = new AWS.S3();
    const transcribe = new AWS.TranscribeService();
    const startRecordBtn = document.getElementById('startRecord');
    const stopRecordBtn = document.getElementById('stopRecord');
    const playRecordBtn = document.getElementById('playRecord');
    const audioPlayer = document.getElementById('audioPlayer');
    const transcriptionResult = document.getElementById('transcriptionResult');
    let mediaRecorder;
    let audioChunks = [];

    // Start Recording
    startRecordBtn.addEventListener('click', () => {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;

                    // Upload to Amazon S3 after recording stops
                    uploadAudioToS3(audioBlob);
                };
                mediaRecorder.start();
                startRecordBtn.disabled = true;
                stopRecordBtn.disabled = false;
                playRecordBtn.disabled = true;
            })
            .catch(error => {
                console.error('Error accessing the microphone:', error);
            });
    });

    // Stop Recording
    stopRecordBtn.addEventListener('click', () => {
        mediaRecorder.stop();
        startRecordBtn.disabled = false;
        stopRecordBtn.disabled = true;
        playRecordBtn.disabled = false;
    });

    // Play the Recorded Audio
    playRecordBtn.addEventListener('click', () => {
        audioPlayer.play();
    });

    // Upload the recorded audio to Amazon S3
    function uploadAudioToS3(audioBlob) {
        const params = {
            Bucket: 'pm-chatgpt-test', // Your S3 bucket name
            Key: `audio/${Date.now()}.wav`, // Use timestamp as the file name
            Body: audioBlob,
            ContentType: 'audio/wav',
        };

        s3.upload(params, function(err, data) {
            if (err) {
                console.log('Error uploading file:', err);
            } else {
                console.log('File uploaded successfully:', data);
                alert('Audio uploaded to S3 successfully!');
                
                // Start transcription after uploading
                startTranscriptionJob(data.Location);
            }
        });
    }

    // Start Transcription Job using Amazon Transcribe
    function startTranscriptionJob(s3AudioUri) {
        const jobName = `job-${Date.now()}`;
        const params = {
            TranscriptionJobName: jobName,
            LanguageCode: 'en-US',
            Media: {
                MediaFileUri: s3AudioUri
            },
            OutputBucketName: 'pm-chatgpt-test', // Your S3 bucket name where the transcription result will be saved
        };

        transcribe.startTranscriptionJob(params, function(err, data) {
            if (err) {
                console.log('Error starting transcription job:', err);
            } else {
                console.log('Transcription job started:', data);
                checkTranscriptionJobStatus(jobName);
            }
        });
    }

    // Poll the status of the transcription job
    function checkTranscriptionJobStatus(jobName) {
        const params = {
            TranscriptionJobName: jobName
        };

        transcribe.getTranscriptionJob(params, function(err, data) {
            if (err) {
                console.log('Error checking transcription job status:', err);
            } else {
                const status = data.TranscriptionJob.TranscriptionJobStatus;
                if (status === 'COMPLETED') {
                    // Transcription completed, get the result
                    const transcriptUri = data.TranscriptionJob.Transcript.TranscriptFileUri;
                    fetchTranscript(transcriptUri);
                } else if (status === 'FAILED') {
                    console.log('Transcription job failed');
                } else {
                    // If the transcription is still in progress, check again after 5 seconds
                    setTimeout(() => checkTranscriptionJobStatus(jobName), 5000);
                }
            }
        });
    }

    // Fetch the transcription result
    function fetchTranscript(transcriptUri) {
        fetch(transcriptUri)
            .then(response => response.json())
            .then(data => {
                const transcript = data.results.transcripts[0].transcript;
                transcriptionResult.value = transcript;  // Display the transcript in the text area
            })
            .catch(error => {
                console.log('Error fetching transcript:', error);
            });
    }
</script>
